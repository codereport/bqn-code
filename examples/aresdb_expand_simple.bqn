# Expand Link: https://github.com/uber/aresdb/blob/a8d2aedc6850b10a6cc9381ba780800290b2756d/query/sort_reduce.cu#L252
# Test Link:   https://github.com/uber/aresdb/blob/a8d2aedc6850b10a6cc9381ba780800290b2756d/query/algorithm_unittest.cu#L1747

u  â‡ â€¢Import "/home/cph/bqn-test/test.bqn"
fn â‡ â€¢Import "/home/cph/bqn-code/lib/fun.bqn"

Expand â† { ğ•Š idvâ€¿idxâ€¿bcâ€¿c: # inputDimValuesâ€¿inputIndexâ€¿baseCountsâ€¿cap
    m â† idxâŠfn.Deltas bc   # mask
    cm â† fn.Deltas 0âˆ¾câŒŠ+`m # capped mask
    idv/Ëœcmâ¥ŠËœâ‰ idv
}

# Tests
inputDimValues â† âŸ¨
    1, 2, 3, 2, 3, 1,
    1, 2, 3, 2, 3, 1,
    1, 2, 3, 2, 3, 1,
    1, 1, 1, 1, 1, 1,
    1, 1, 1, 1, 1, 1,
    1, 1, 1, 1, 1, 1
âŸ©
inputIndex â† âŸ¨1, 2, 4, 7, 9, 12âŸ©
baseCounts â† âŸ¨0, 0, 1, 3, 4, 7, 8, 10, 13, 14, 16, 19, 22, 23, 26, 30âŸ©
expectedDimValues â† âŸ¨
    1, 2, 2, 3, 3, 3, 2, 2, 2, 3,
    1, 2, 2, 3, 3, 3, 2, 2, 2, 3,
    1, 2, 2, 3, 3, 3, 2, 2, 2, 3,
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
âŸ©


cap  â† 10

u.UnitTest (Expand âŸ¨inputDimValues, inputIndex, baseCounts, capâŸ©) â‰¡ expectedDimValues
